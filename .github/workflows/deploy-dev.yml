name: Deploy to DEV

on:
  push:
    branches: [main]

env:
  AWS_REGION: eu-west-2
  AWS_ACCOUNT_ID: 437064342167
  ECR_REGISTRY: 437064342167.dkr.ecr.eu-west-2.amazonaws.com
  ECS_CLUSTER: counterpromo-dev-cluster

jobs:
  deploy-api:
    name: Build & Deploy API
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/counterpromo-dev-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push API image
        run: |
          IMAGE=${{ env.ECR_REGISTRY }}/counterpromo-dev-api:${{ github.sha }}
          docker build -f apps/api/Dockerfile -t $IMAGE .
          docker push $IMAGE
          echo "API_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy API to ECS
        run: |
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition counterpromo-dev-td-api \
            --query 'taskDefinition' --output json)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq \
            --arg IMAGE "${{ env.API_IMAGE }}" \
            '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.placementConstraints,.registeredAt,.registeredBy,.compatibilities)')
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service counterpromo-dev-api \
            --task-definition $NEW_TASK_ARN \
            --force-new-deployment

  deploy-worker:
    name: Build & Deploy Worker
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/counterpromo-dev-github-deployer
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & push Worker image
        run: |
          IMAGE=${{ env.ECR_REGISTRY }}/counterpromo-dev-worker:${{ github.sha }}
          docker build -f apps/worker/Dockerfile -t $IMAGE .
          docker push $IMAGE
          echo "WORKER_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Worker to ECS
        run: |
          TASK_DEF=$(aws ecs describe-task-definition \
            --task-definition counterpromo-dev-td-worker \
            --query 'taskDefinition' --output json)
          NEW_TASK_DEF=$(echo $TASK_DEF | jq \
            --arg IMAGE "${{ env.WORKER_IMAGE }}" \
            '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.placementConstraints,.registeredAt,.registeredBy,.compatibilities)')
          NEW_TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEF" \
            --query 'taskDefinition.taskDefinitionArn' --output text)
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service counterpromo-dev-worker \
            --task-definition $NEW_TASK_ARN \
            --force-new-deployment
