name: Deploy API (dev)

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/db/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-api-dev.yml'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER: counterpromo-dev-cluster
  SERVICE: counterpromo-dev-td-api-service-14ngyomh
  TASK_FAMILY: counterpromo-dev-td-api
  ECR_REPO: counterpromo-dev-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO"
          IMAGE_TAG="${GITHUB_SHA}"
          docker build -f apps/api/Dockerfile -t "$ECR_URI:$IMAGE_TAG" .
          docker push "$ECR_URI:$IMAGE_TAG"
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Register new task definition revision (update image)
        run: |
          aws ecs describe-task-definition --task-definition "$TASK_FAMILY" \
            --query taskDefinition > td.json

          cat td.json | jq 'del(
            .taskDefinitionArn,
            .revision,
            .status,
            .requiresAttributes,
            .compatibilities,
            .registeredAt,
            .registeredBy
          )' > td-clean.json

          cat td-clean.json | jq --arg IMG "$ECR_URI:$IMAGE_TAG" '
            .containerDefinitions |=
              (map(if .name=="api" then .image=$IMG else . end))
          ' > td-new.json

          aws ecs register-task-definition --cli-input-json file://td-new.json \
            --query taskDefinition.revision --output text > rev.txt

          echo "NEW_REV=$(cat rev.txt)" >> $GITHUB_ENV

      - name: Run DB migration
        run: |
          TASK_ARN=$(aws ecs run-task \
            --cluster "$CLUSTER" \
            --task-definition "$TASK_FAMILY:$NEW_REV" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-0f40232407cf12c10,subnet-03b576bcd0fec5e20],securityGroups=[sg-01536322f2e7edde1],assignPublicIp=DISABLED}" \
            --overrides "{\"containerOverrides\":[{\"name\":\"api\",\"command\":[\"sh\",\"-c\",\"export DATABASE_URL=\\\"postgresql://\${DB_USERNAME}:\${DB_PASSWORD}@\${DB_HOST}:\${DB_PORT}/\${DB_NAME}\\\" && npx prisma migrate deploy --schema packages/db/prisma/schema.prisma\"]}]}" \
            --query 'tasks[0].taskArn' --output text)
          echo "Migration task ARN: $TASK_ARN"
          aws ecs wait tasks-stopped --cluster "$CLUSTER" --tasks "$TASK_ARN"
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "$CLUSTER" --tasks "$TASK_ARN" \
            --query 'tasks[0].containers[0].exitCode' --output text)
          echo "Migration exit code: $EXIT_CODE"
          if [ "$EXIT_CODE" != "0" ]; then
            echo "::error::DB migration failed â€” deploy aborted"
            exit 1
          fi

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$SERVICE" \
            --task-definition "$TASK_FAMILY:$NEW_REV" \
            --force-new-deployment
