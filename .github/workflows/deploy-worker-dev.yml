name: Deploy Worker (dev)

on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  CLUSTER: counterpromo-dev-cluster
  SERVICE: counterpromo-dev-svc-worker
  TASK_FAMILY: counterpromo-dev-td-worker
  ECR_REPO: counterpromo-dev-worker

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        working-directory: worker
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO"
          IMAGE_TAG="${GITHUB_SHA}"
          docker build -t "$ECR_URI:$IMAGE_TAG" .
          docker push "$ECR_URI:$IMAGE_TAG"
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Register new task definition revision (update image)
        run: |
          aws ecs describe-task-definition --task-definition "$TASK_FAMILY" \
            --query taskDefinition > td.json

          cat td.json | jq 'del(
            .taskDefinitionArn,
            .revision,
            .status,
            .requiresAttributes,
            .compatibilities,
            .registeredAt,
            .registeredBy
          )' > td-clean.json

          cat td-clean.json | jq --arg IMG "$ECR_URI:$IMAGE_TAG" '
            .containerDefinitions |=
              (map(if .name=="worker" then .image=$IMG else . end))
          ' > td-new.json

          aws ecs register-task-definition --cli-input-json file://td-new.json \
            --query taskDefinition.revision --output text > rev.txt

          echo "NEW_REV=$(cat rev.txt)" >> $GITHUB_ENV

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$SERVICE" \
            --task-definition "$TASK_FAMILY:$NEW_REV" \
            --force-new-deployment
